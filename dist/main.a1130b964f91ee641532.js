(()=>{"use strict";const e=document.querySelector(".nav-toggle"),t=document.querySelector(".links"),n=document.querySelector(".box-container"),s=(document.querySelector(".popup-container"),document.querySelector(".shown-movies")),a=(document.querySelector("#movie-close-btn"),document.querySelector("#close-reservation"),document.querySelector(".popup-section")),o=document.querySelector(".reservation-section"),i=(document.querySelector("nav"),"https://us-central1-involvement-api.cloudfunctions.net/capstoneApi/apps/xK5LmH1OlvUhFH39ssaa/comments"),r=(document.querySelector(".btn-comments"),document.querySelector(".add-comments"),document.querySelector("#commenter-name"),document.querySelector("#comment-text"),"https://us-central1-involvement-api.cloudfunctions.net/capstoneApi/apps/milQHnStnYxG5awlXqqf/likes/"),c=document.querySelector(".year"),l=(e,t)=>{e.forEach((e=>{const n=`\n    <div class="comment-div">\n    <h4>${e.username} ${e.creation_date}</h4>\n    <p>${e.comment}</p>\n    </div>`;t.innerHTML+=n}))},d=(e,t)=>{t.innerHTML=`Comments ${(e=>{let t=0;return e.forEach((()=>{t+=1})),t})(e)}`},m=async e=>{const t=await fetch(`${i}?item_id=${e}`);return 400!==t.status?t.json():[]},u=async e=>await fetch(`https://us-central1-involvement-api.cloudfunctions.net/capstoneApi/apps/xK5LmH1OlvUhFH39ssaa/reservations?item_id="${e}"`).then((e=>e.json())),p=e=>e.length,v=async(e,t)=>{let n=parseInt(t.lastElementChild.textContent,10);const s=t.firstElementChild;await(async e=>await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id:e})}))(parseInt(e,10))&&(n+=1,t.lastElementChild.innerText=n,s.classList.add("fa-solid"))};(async()=>{const e=await(async e=>await fetch(`https://api.tvmaze.com/search/shows?q=${e}`).then((e=>e.json())))("d"),t=await(async()=>await fetch(`${r}`).then((e=>e.json())))(),c=new DocumentFragment,v=new DOMParser;e.forEach(((e,n)=>{const{show:s}=e,a=t.find((e=>e.item_id===s.id));let o=0;a&&(o=a.likes);const i=`\n            <div class="box" data-id=${e.show.id}>\n              <div class="box-img">\n                <img src="${s.image.original}" alt="${s.name}"/>\n              </div>\n              <div class="box-desc">\n                <h4>${s.name}</h4>\n                <div class="likes" data-id="${s.id}" role="button">          \n                  <a href="#" class="like-btn"><i class="fa-regular fa-heart fa-solid"></i></a>\n                <p>${o}</p>\n                </div>    \n              </div>\n              <div class="btn-container" data-index="${n}" role="button">\n                <button class="btn btn-comments" id=${s.externals.thetvdb}>\n                  Comments\n              </button>\n                <button type="button" class="btn btn-reservation" id="${e.show.externals.imdb}">Reservations</button>\n              </div>\n            </div>`,r=v.parseFromString(i,"text/html").body.firstChild;c.appendChild(r)})),n.appendChild(c);const y=(e=>{const t=document.querySelectorAll(`.${e}`);let n=0;return t.forEach((()=>{n+=1})),n})("box");s.innerText=`Shows(${y})`,document.querySelectorAll(".btn-comments").forEach((e=>{e.addEventListener("click",(async e=>{a.style.display="block";const t=e.target.id,n=await fetch(`https://api.tvmaze.com/lookup/shows?thetvdb=${t}`).then((e=>e.json())),s=`<div class="popup-container">\n      <button type="button" class="btn comments-close-btn" id="movie-close-btn">\n        <i class="fas fa-times"></i>\n      </button>\n      <div class="popup-img">\n        <img\n          src="${n.image.original}"\n          alt="${n.name}"\n        />\n      </div>\n      <div class="title-description">\n        <h3>${n.name}</h3>\n        <div class="popup-description">\n        <p>Genres: ${n.genres}</p>\n        <p>Language: ${n.language}</p>\n        <p>Premiered: ${n.premiered}</p>\n        <p>Country: ${n.network.country.name}</p>\n        </div>\n      </div>\n      <div class="popup-comments">\n        <h3 class="comment-header"></h3>\n        <div class="list-of-comments">\n          \n        </div>\n      </div>\n      <form method="post" class="add-comments">\n        <h3>Add Comments</h3>\n        <div class="input-field">\n          <input\n            type="text"\n            placeholder="Your name"\n            class="input"\n            id="commenter-name"\n            required\n          />\n        </div>\n        <div class="input-field">\n          <textarea\n            id="comment-text"\n            class="input"\n            cols="30"\n            rows="5"\n            placeholder="Your comments"\n            required\n          ></textarea>\n        </div>\n        <div class="btn-container">\n          <button type="submit" class="btn" id="${e.target.id}">Comment</button>\n        </div>\n      </form>\n      </div>`;a.innerHTML=s;const o=document.querySelector(".comment-header"),r=document.querySelector(".list-of-comments");let c=await m(t);l(c,r);let u=document.querySelectorAll(".comment-div");d(u,o);const p=document.querySelector(".add-comments"),v=document.querySelector("#commenter-name"),y=document.querySelector("#comment-text");p.addEventListener("submit",(async e=>{e.preventDefault(),await(async(e,t,n)=>await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({item_id:e,username:t,comment:n})}))(t,v.value,y.value),r.innerHTML="",o.innerHTML="",c=await m(t),l(c,r),u=document.querySelectorAll(".comment-div"),d(u,o),p.reset()}))}))})),document.querySelectorAll(".btn-reservation").forEach((e=>{e.addEventListener("click",(async()=>{const t=await(async e=>await fetch(`https://api.tvmaze.com/lookup/shows?imdb=${e}`).then((e=>e.json())))(e.id);o.style.display="block";const n=`<div class="reservation-container">\n        <button type="button" class="btn reservation-close-btn" id="close-reservation">\n          <i class="fas fa-times"></i>\n        </button>\n        <div class="reservation-img">\n          <img\n            src="${t.image.original}"\n            alt="${t.name}"\n          />\n        </div>\n        <div class="reservation-description">\n          <h3>${t.name}</h3>\n          <div class="reservations">\n            <p>Genres: ${t.genres}</p>\n            <p>Language: ${t.language}</p>\n            <p>Premiered: ${t.premiered}</p>\n            <p>Country: ${t.network.country.name}</p>\n          </div>\n        </div>\n        <div class="popup-reservations">\n          <h3>Reservations<span id="counter-reservations"></span></h3>\n          <div class="list-of-reservations">\n          </div>\n        </div>\n        <form method="post" class="add-reservation">\n          <h3>Add a reservation</h3>\n          <div class="input-field">\n          <input type="text" placeholder="Your name" class="input" name="name" id="nameReservation"/>\n          </div>\n          <div class="input-field">\n          <label for="startDate">Start date:</label>\n          <input type="text" placeholder="yyyy-mm-dd" class="input" name="startDate" id="startDate"/>\n          </div>\n          <div class="input-field">\n          <label for="endDate">End date:</label>\n          <input type="text" placeholder="yyyy-mm-dd" class="input" name="endDate" id="endDate"/>\n          </div>\n          <div class="btn-container">\n            <button type="submit" class="btn" id="reserve">Reserve</button>\n            <p class="alarm-form-reservations"></p>\n          </div>\n        </form>\n      </div>`;o.innerHTML=n,document.getElementById("reserve").addEventListener("click",(async t=>{const n=document.querySelector(".alarm-form-reservations"),s=document.getElementById("nameReservation").value,a=document.getElementById("startDate").value,o=document.getElementById("endDate").value;if(s&&a&&o){n.innerHTML="";const i=/^\d{4}-\d{2}-\d{2}$/;if(a.match(i)&&o.match(i)){n.style.color="green",n.innerHTML="Reservation Completed",await(async(e,t,n,s,a)=>(e.preventDefault(),await fetch("https://us-central1-involvement-api.cloudfunctions.net/capstoneApi/apps/xK5LmH1OlvUhFH39ssaa/reservations/",{method:"POST",body:JSON.stringify({item_id:`"${t}"`,username:`"${n}"`,date_start:`"${s}"`,date_end:`"${a}"`}),headers:{"Content-type":"application/json; charset=UTF-8"}})))(t,e.id,s,a,o);const i=await u(e.id);let r="";i.forEach((e=>{r+=`<p class="counterR">${e.date_start}/${e.date_end} by ${e.username}</p>`})),document.querySelector(".list-of-reservations").innerHTML=r;const c=document.querySelectorAll(".counterR"),l=p(c);document.getElementById("counter-reservations").innerHTML=`(${l})`}else n.style.color="red",n.innerHTML="*Date format has to be yyyy-mm-dd",t.preventDefault()}else n.innerHTML="*All fields need be populated",t.preventDefault()}));const s=await u(e.id);let a="";s.forEach((e=>{a+=`<p class="counterR">${e.date_start}/${e.date_end} by ${e.username}</p>`})),document.querySelector(".list-of-reservations").innerHTML=a;const i=document.querySelectorAll(".counterR"),r=p(i);document.getElementById("counter-reservations").innerHTML=`(${r})`}))}))})().then((()=>{document.querySelectorAll(".likes").forEach((e=>{const{id:t}=e.dataset;e.addEventListener("click",(()=>{v(t,e)}),{once:!0})}))})),e.addEventListener("click",(()=>{t.classList.toggle("show-links")})),a.addEventListener("click",(e=>{"btn comments-close-btn"!==e.target.className&&"fas fa-times"!==e.target.className||(a.style.display="none")})),o.addEventListener("click",(e=>{"btn reservation-close-btn"!==e.target.className&&"fas fa-times"!==e.target.className||(o.style.display="none")})),(()=>{const e=(new Date).getFullYear();c.textContent=e})()})();